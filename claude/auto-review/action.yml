name: "Claude Auto Review"
description: "Automated code review using Claude AI with configurable project context"
author: "WalletConnect"

inputs:
  anthropic_api_key:
    description: "Anthropic API key for Claude access"
    required: true
  model:
    description: "Claude model to use for reviews"
    required: false
    default: "claude-sonnet-4-5-20250929"
  timeout_minutes:
    description: "DEPRECATED: Accepted but ignored by v1 (no effect). Use job-level timeout-minutes instead."
    required: false
  custom_prompt:
    description: "Complete custom prompt override. If provided, all other prompt-related inputs are ignored."
    required: false
  project_context:
    description: "Additional project-specific context to help Claude understand your codebase"
    required: false
  comment_pr_findings:
    description: "Post inline PR comments generated from findings.json"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Set up review prompt
      shell: bash
      run: |
        # Create prompt header with context
        PROMPT_HEADER="REPO: ${{ github.repository }}
        PR NUMBER: ${{ github.event.pull_request.number }}

        "

        if [[ -n "${{ inputs.custom_prompt }}" ]]; then
          # Use custom prompt directly with header
          PROMPT="${PROMPT_HEADER}${{ inputs.custom_prompt }}"
        else
          # Build dynamic prompt based on inputs
          PROMPT="${PROMPT_HEADER}## CRITICAL CONSTRAINTS

        Be extremely concise and sacrifice grammar for concision. Read-only mode: no shell commands, builds, or execution. Issues-only: report problems, never praise. If no issues: \"âœ… No issues found\"

        ---

        ## REVIEW SCOPE

        Focus on:
        - Code quality/best practices for project technologies
        - Bugs (especially critical paths, async ops)
        - Performance (frontend/backend)
        - Security (auth, APIs, data handling)
        - Test coverage/quality
        - Type safety, error handling, edge cases
        - Maintainability/readability

        **Diffs alone are not enough.** Read full file(s) to understand context. Code that looks wrong in isolation may be correct given surrounding logic.

        ### Incremental Review Guidelines (for PR updates)

        **IMPORTANT: For PR synchronize events (subsequent pushes), be incremental:**
        1. First, examine all existing review comments in this PR thread for context
        2. **Extract existing issue IDs** from previous auto-review comments (look for **ID:** fields in comments starting with \\\"ðŸ¤– **Auto Review Issue:\\\")
        3. For each previously reported issue:
           - Check if the issue still exists in the current code state
           - If it **STILL EXISTS**: Reuse the EXACT SAME ID from the previous review (even if the line number changed)
           - If it's **RESOLVED**: Note it in your summary with the ID (don't create a new issue entry for it)
        4. **CRITICAL: Only report previously mentioned issues if you can confirm they still exist** by examining the actual current code
        5. For genuinely **NEW** issues: Generate a new ID using the ID Generation Rules
        6. Clearly note when previously flagged issues have been resolved since the last review
        7. When referencing issues originally identified by other tools (GitHub Copilot, Cursor, etc.), explicitly validate their current relevance and state \\\"Confirmed still present\\\" or \\\"Resolved since previous review\\\"

        **ID Reuse Example:**
        Previous review had: **ID:** login-sql-injection-f3a2 at line 42
        Current review finds same issue at line 48 â†’ Use SAME ID: **ID:** login-sql-injection-f3a2
        (Update the line number to 48, but keep the ID unchanged)

        **For initial PR reviews or if no previous comments exist, provide a full review.**

        ---

        ## AUTOMATED CHECKS

        **Only report if violations found. Skip check if none detected.**

        ### PR Size Assessment (Check FIRST)
        Count files changed and total lines added/removed. Flag if >15 files OR >800 lines changed:

        ðŸš¨ **This PR is Too Large**
        **Files Changed:** [N] | **Lines Changed:** [N]
        **Severity:** HIGH
        **Category:** maintainability

        Look, we need to talk. This PR is trying to do too much. PRs this size are:
        - Harder to review thoroughly (reviewer fatigue is real)
        - More likely to hide bugs in the noise
        - A merge conflict waiting to happen
        - Making your teammates mass "LGTM" just to make it go away

        **Suggested Split Strategy:**

        Analyze the changes and suggest 2-4 smaller, focused PRs. Consider BOTH:

        1. **By Logical Concern:**
           - Separate refactoring from new features
           - Split infrastructure changes from business logic
           - Isolate dependency updates
           - Keep bug fixes atomic

        2. **By File/Directory Groupings:**
           - Group files that change together semantically
           - Identify independent modules that can ship separately
           - Flag cross-cutting changes that touch everything (these often indicate the PR scope is too broad)

        **Recommended PRs:**
        - PR 1: [Brief description] - [files/directories involved]
        - PR 2: [Brief description] - [files/directories involved]
        ...

        **Pro tip:** If you can't describe what a PR does in one sentence, it's probably doing too much.

        ---

        ### External Domain URLs
        Flag URLs to domains other than reown.com, walletconnect.com, walletconnect.org:
        ðŸ”’ **External Domain URL** (Non-blocking) **URL:** [url] **File:** [path:line] - Verify intentional, review security implications.

        ### Static Resource Cache-Control
        Flag static files (.woff, .woff2, .ttf, .jpg, .png, .css, .js, .mp4, etc.) with max-age < 31536000 or missing explicit Cache-Control:
        âš ï¸ **Cache-Control Issue** **Resource:** [url] **File:** [path:line] **Current:** [value] **Recommendation:** \"Cache-Control: public, max-age=31536000, immutable\"

        ### GitHub Actions Workflow Security
        Scan .github/workflows/*.y*ml for:
        - **CRITICAL:** pull_request_target + PR head checkout (github.event.pull_request.head.*) = arbitrary code execution
        - **HIGH:** pull_request_target + script execution
        - **MEDIUM:** Any pull_request_target usage (runs with secrets)
        Format: ðŸš¨ **GitHub Actions Security Risk** **Severity:** [level] **File:** [path:line] **Pattern:** [issue] **Recommendation:** [fix]

        ### WalletConnect Pay Architecture
        Flag anti-patterns in payment/wallet/transaction code:
        1. **CRITICAL:** Cross-service DB access (imports, queries, connections) â†’ ðŸš¨ Services must use APIs
        2. **HIGH:** Missing idempotency keys in POST/PUT/PATCH/DELETE â†’ âš ï¸ Extract key, check store, return cached response
        3. **HIGH:** External calls without timeout/retry â†’ âš ï¸ Add timeout, retry+backoff, circuit breaker
        4. **HIGH:** Event consumers (SQS/SNS/Kafka) without message deduplication â†’ âš ï¸ Check message ID before mutations
        5. **MEDIUM:** Multi-step workflows without saga compensation â†’ âš ï¸ Add rollback/compensating events
        6. **MEDIUM:** State transitions without trace context â†’ âš ï¸ Add structured logging with traceId/correlationId"


          # Add project context
          if [[ -n "${{ inputs.project_context }}" ]]; then
            PROMPT="$PROMPT

        **Project-specific context:**
        ${{ inputs.project_context }}"
          fi

          # Add response format guidelines
          PROMPT="$PROMPT

        ---

        ## RESPONSE FORMAT

        For incremental reviews: Start with \"ðŸ”„ Incremental Review:\" and focus only on changes since last review. If no new issues: \"âœ… No new issues found in latest commits\"
        For full reviews: Be concise - ONLY report issues that need fixing. If no issues: \"âœ… No issues found\"

        Wrap ALL issues in collapsed <details> section. No praise, issues-only.

        **Issue Format:**
        <details>
        <summary>Found N issue(s)</summary>

        #### Issue 1: Brief description
        **ID:** {file-slug}-{semantic-slug}-{hash}
        **File:** path/to/file.ext:123
        **Severity:** HIGH/MEDIUM/LOW
        **Category:** security/performance/code_quality

        **Context:**
        - **Pattern:** What the problematic code pattern is
        - **Risk:** Why it's a problem technically
        - **Impact:** Potential consequences (exploit, data loss, etc.)
        - **Trigger:** Under what conditions this becomes exploitable

        **Recommendation:** Fix with minimal code snippet (1-10 lines).
        </details>

        **ID Generation:** {filename}-{2-4-key-terms}-{SHA256(path+desc).substr(0,4)}
        Example: login-sql-injection-f3a2

        **Recommendation Guidelines:** Include focused code snippets showing exact fix. DO: show specific changes needed. DON'T: provide full implementations or boilerplate.

        **Example:**
        <details>
        <summary>Found 1 issue(s)</summary>

        #### Issue 1: SQL injection in user query
        **ID:** users-sql-injection-f3a2
        **File:** src/database/users.ts:45
        **Severity:** HIGH
        **Category:** security

        **Context:**
        - **Pattern:** Query at line 45 builds SQL via string concatenation with user-provided \`userId\`
        - **Risk:** Allows arbitrary SQL injection via crafted input (e.g., \`1' OR '1'='1\`)
        - **Impact:** Unauthorized data access, modification, or database destruction
        - **Trigger:** Any endpoint accepting user input that reaches this query

        **Recommendation:** Use parameterized queries:
        \\\`\\\`\\\`typescript
        const result = await db.query('SELECT * FROM users WHERE id = $1', [userId]);
        \\\`\\\`\\\`
        </details>

        **Rules:** Use \\\"Issue N:\\\" not \\\"#N\\\". Include line numbers. Include code snippets in recommendations

        **Feedback Style:** Provide constructive feedback with specific suggestions. Consider impact on system architecture and user experience. Focus exclusively on problems and their solutions"
        fi

        # Set environment variable for the next step
        echo "REVIEW_PROMPT<<EOF" >> $GITHUB_ENV
        echo "$PROMPT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Check timeout_minutes deprecation
      shell: bash
      run: |
        if [[ -n "${{ inputs.timeout_minutes }}" ]]; then
          echo "::warning::The 'timeout_minutes' input is deprecated and has no effect in claude-code-action@v1. Please use job-level 'timeout-minutes' instead. See: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idtimeout-minutes"
        fi

    - name: Automatic PR Review
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        prompt: ${{ env.REVIEW_PROMPT }}
        track_progress: true
        claude_args: --model ${{ inputs.model }}
        allowed_bots: devin-ai-integration[bot]

    - name: Extract findings from Claude's comment
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        echo "Extracting findings from Claude's PR comment..."

        SCRIPT_PATH="${{ github.action_path }}/scripts/extract-findings-from-comment.js"

        if [[ ! -f "$SCRIPT_PATH" ]]; then
          echo "::warning::Extract findings script not found at $SCRIPT_PATH"
          echo "[]" > findings.json
          exit 0
        fi

        chmod +x "$SCRIPT_PATH"
        node "$SCRIPT_PATH"

    - name: Ensure GitHub CLI and jq for inline comments
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      run: |
        # Install GitHub CLI if needed
        if ! command -v gh >/dev/null 2>&1; then
          echo "::group::Installing GitHub CLI"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          elif command -v brew >/dev/null 2>&1; then
            brew install gh
          else
            echo "::warning::Unable to auto-install GitHub CLI on this runner. Please ensure gh is available."
          fi
          echo "::endgroup::"
        else
          echo "GitHub CLI already available"
        fi

        # Install jq if needed
        if ! command -v jq >/dev/null 2>&1; then
          echo "::group::Installing jq"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          elif command -v brew >/dev/null 2>&1; then
            brew install jq
          else
            echo "::warning::Unable to auto-install jq on this runner. Please ensure jq is available."
          fi
          echo "::endgroup::"
        else
          echo "jq already available"
        fi

    - name: Post inline findings comments
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GITHUB_TOKEN: ${{ github.token }}
        SILENCE_AUTO_REVIEW_COMMENTS: ${{ env.SILENCE_AUTO_REVIEW_COMMENTS }}
      run: |
        if [[ ! -f findings.json ]]; then
          echo "findings.json not present, skipping inline comment step."
          exit 0
        fi

        # Check if findings.json has any findings
        FINDINGS_COUNT=$(jq 'length' findings.json 2>/dev/null || echo "0")
        if [[ "$FINDINGS_COUNT" -eq 0 ]]; then
          echo "No findings to comment on (findings.json is empty)."
          exit 0
        fi

        echo "Found $FINDINGS_COUNT findings to comment on."

        SCRIPT_PATH="${{ github.action_path }}/scripts/comment-pr-findings.js"

        if [[ ! -f "$SCRIPT_PATH" ]]; then
          echo "::warning::Inline comment script not found at $SCRIPT_PATH"
          exit 0
        fi

        chmod +x "$SCRIPT_PATH"
        node "$SCRIPT_PATH"
