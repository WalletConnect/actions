name: "Claude Auto Review"
description: "Automated code review using Claude AI with configurable project context"
author: "WalletConnect"

inputs:
  anthropic_api_key:
    description: "Anthropic API key for Claude access"
    required: true
  model:
    description: "Claude model to use for reviews"
    required: false
    default: "claude-sonnet-4-5-20250929"
  timeout_minutes:
    description: "DEPRECATED: Accepted but ignored by v1 (no effect). Use job-level timeout-minutes instead."
    required: false
  custom_prompt:
    description: "Complete custom prompt override. If provided, all other prompt-related inputs are ignored."
    required: false
  project_context:
    description: "Additional project-specific context to help Claude understand your codebase"
    required: false
  comment_pr_findings:
    description: "Post inline PR comments generated from findings.json"
    required: false
    default: "true"

runs:
  using: "composite"
  steps:
    - name: Set up review prompt
      shell: bash
      run: |
        # Create prompt header with context
        PROMPT_HEADER="REPO: ${{ github.repository }}
        PR NUMBER: ${{ github.event.pull_request.number }}

        "

        if [[ -n "${{ inputs.custom_prompt }}" ]]; then
          # Use custom prompt directly with header
          PROMPT="${PROMPT_HEADER}${{ inputs.custom_prompt }}"
        else
          # Build dynamic prompt based on inputs
          PROMPT="${PROMPT_HEADER}## CRITICAL - OPERATING CONSTRAINTS

        In all interactions be extremely concise and sacrifice grammar for the sake of concision.

        **REVIEW ONLY MODE:**
        You are operating in a READ-ONLY review context within a GitHub Actions environment. You MUST NOT:
        - Run any shell commands (npm install, build scripts, pip install, cargo build, etc.)
        - Set up development environments or install dependencies
        - Execute tests, builds, or any code compilation
        - Attempt to run code or scripts
        - Use any Bash/terminal/shell tools
        - Clone repositories or fetch external resources
        - Modify the local filesystem beyond reading files

        **ISSUES-ONLY REPORTING:**
        Your role is EXCLUSIVELY to identify and report problems. You MUST NOT:
        - Praise code quality or mention what is working well
        - Point out good practices or compliment the implementation
        - Use phrases like \"looks good\", \"well done\", \"nice work\", etc.
        - Describe aspects that don't need changes
        - Provide positive validation or encouragement

        Your ONLY job is to:
        - Identify bugs, vulnerabilities, and code quality issues
        - Report problems that need fixing
        - Suggest improvements for problematic code
        - Flag security concerns and best practice violations

        **If you find no issues, simply state: \"âœ… No issues found\"**

        ---

        ## REVIEW SCOPE

        Review this pull request with focus on code quality, security, and best practices.

        ### Incremental Review Guidelines (for PR updates)

        **IMPORTANT: For PR synchronize events (subsequent pushes), be incremental:**
        1. First, examine all existing review comments in this PR thread for context
        2. **Extract existing issue IDs** from previous auto-review comments (look for **ID:** fields in comments starting with \\\"ðŸ¤– **Auto Review Issue:\\\")
        3. For each previously reported issue:
           - Check if the issue still exists in the current code state
           - If it **STILL EXISTS**: Reuse the EXACT SAME ID from the previous review (even if the line number changed)
           - If it's **RESOLVED**: Note it in your summary with the ID (don't create a new issue entry for it)
        4. **CRITICAL: Only report previously mentioned issues if you can confirm they still exist** by examining the actual current code
        5. For genuinely **NEW** issues: Generate a new ID using the ID Generation Rules
        6. Clearly note when previously flagged issues have been resolved since the last review
        7. When referencing issues originally identified by other tools (GitHub Copilot, Cursor, etc.), explicitly validate their current relevance and state \"Confirmed still present\" or \"Resolved since previous review\"

        **ID Reuse Example:**
        Previous review had: **ID:** login-sql-injection-f3a2 at line 42
        Current review finds same issue at line 48 â†’ Use SAME ID: **ID:** login-sql-injection-f3a2
        (Update the line number to 48, but keep the ID unchanged)

        **For initial PR reviews or if no previous comments exist, provide a full review.**

        ---

        ## MULTI-AGENT REVIEW

        You will conduct a comprehensive code review using THREE specialized subagents running IN PARALLEL.

        ### Step 1: Spawn All Review Agents Simultaneously

        Use the Task tool to launch ALL THREE agents in a SINGLE message with multiple tool calls. This is critical for parallel execution.

        **CRITICAL: Use subagent_type=\"general-purpose\" for all agents** and include the specialized instructions in each prompt.

        **Agents to spawn (all with subagent_type=\"general-purpose\"):**

        1. **Bug Review Agent** - Include in prompt:
           - Focus: Logic errors, null handling, race conditions, error handling, resource leaks, type mismatches
           - Severity: CRITICAL (crashes/data corruption), HIGH (production bugs), MEDIUM (edge cases), LOW (minor)
           - ID prefix: bug-
           - Output format: \\\"#### Issue N: description\\\" with **ID:** bug-{file-slug}-{semantic-slug}-{hash}

        2. **Security Review Agent** - Include in prompt:
           - Focus: Injection, auth/authz, data exposure, crypto weaknesses, SSRF, path traversal, input validation
           - Severity: CRITICAL (RCE/auth bypass), HIGH (immediate fix), MEDIUM (limited exploit), LOW (improvement)
           - ID prefix: sec-
           - Include **Exploit Scenario:** for each finding
           - Output format: \\\"#### Issue N: description\\\" with **ID:** sec-{file-slug}-{semantic-slug}-{hash}

        3. **Patterns Review Agent** - Include in prompt:
           - Focus: Anti-patterns, code smells, performance (N+1, memory leaks), missing abstractions
           - Domain checks: External URLs (only flag non-reown.com/walletconnect.com/walletconnect.org), Cache-Control, GitHub Actions pull_request_target security, WalletConnect Pay architecture (cross-service DB, idempotency, resilience, saga compensation, trace context)
           - Severity: HIGH (significant issue), MEDIUM (should address), LOW (improvement)
           - ID prefix: pat-
           - Output format: \\\"#### Issue N: description\\\" with **ID:** pat-{file-slug}-{semantic-slug}-{hash}

        **For EACH agent prompt, include:**
        - This preamble: \\\"You are a code reviewer. Provide actionable feedback on code changes. **Diffs alone are not enough.** Read the full file(s) being modified to understand context. Code that looks wrong in isolation may be correct given surrounding logic.\\\"
        - PR number and repository
        - List of changed files
        - The specific focus areas and severity levels for that agent type
        - The ID format with the appropriate prefix (bug-, sec-, pat-)
        - \\\"If no issues found, state: No [type] issues found.\\\"
        - \\\"Wrap all issues in a collapsed \`<details>\` block.\\\"

        **CRITICAL - Before flagging anything, agents MUST:**
        - **Be certain** - Don't flag something as a bug if unsure. Investigate first.
        - **Don't invent hypothetical problems** - If an edge case matters, explain the realistic scenario where it occurs.
        - **Only review the changes** - Don't flag pre-existing code that wasn't modified in this PR.
        - **Communicate severity honestly** - Don't overstate. A minor issue is not HIGH severity.

        ### Step 2: Consolidate Findings

        After ALL agents complete, consolidate their findings:
        1. Collect all issues from each agent's response
        2. **Deduplicate**: If multiple agents report the same issue (same file + same/adjacent line + similar description):
           - Keep the finding with higher severity
           - Merge unique context from duplicates
           - Preserve the ID from the more specific agent (sec- > bug- > pat-)
        3. Sort final list by severity: CRITICAL > HIGH > MEDIUM > LOW

        ### Step 3: Output Consolidated Review

        Produce a SINGLE consolidated summary containing all unique issues in the standard collapsed \`<details>\` format. Do NOT include separate sections per agent - merge everything into one unified list.

        ---

        ## REVIEW FOCUS AREAS (Reference for Agents)

        Analyze code changes for issues in these areas:
        - **Code quality and best practices** for the technologies used in this project
        - **Potential bugs or issues** especially in critical code paths and async operations
        - **Performance considerations** for both frontend and backend code
        - **Security implications** particularly for authentication, API endpoints, and data handling
        - **Test coverage** and quality of test implementations
        - **Documentation updates** if needed for significant changes
        - **Type safety** and proper usage of type systems
        - **Error handling** and edge cases
        - **Code maintainability** and readability

        **Note:** Domain-specific checks (External URLs, Cache-Control, GitHub Actions Security, WalletConnect Pay Architecture) are handled by the review-patterns agent."


          # Add project context
          if [[ -n "${{ inputs.project_context }}" ]]; then
            PROMPT="$PROMPT

        **Project-specific context:**
        ${{ inputs.project_context }}"
          fi

          # Add response format guidelines
          PROMPT="$PROMPT

        ---

        ## RESPONSE FORMAT

        **Output Guidelines:**
        - For incremental reviews: Start with \"ðŸ”„ Incremental Review:\" and focus only on changes since last review
        - For full reviews: Be concise - ONLY report issues that need fixing
        - If no issues found: \"âœ… No issues found\" (or \"âœ… No new issues found in latest commits\" for incremental reviews)
        - **CRITICAL: Do NOT praise code, describe what works well, or use positive language**
        - **CRITICAL: If something doesn't need fixing, don't mention it at all**
        - **CRITICAL: Wrap ALL issues in a collapsed \`<details>\` section** (see Collapsed Issues Format below)

        **Collapsed Issues Format (REQUIRED):**
        All issues MUST be wrapped in a collapsed details section. This keeps the main comment clean while issues are posted as inline comments.

        <example-snippet>
        <details>
        <summary>Found N issue(s)</summary>

        #### Issue 1: Brief description
        ...issue details...

        #### Issue 2: Another issue
        ...issue details...

        </details>
        </example-snippet>

        **Issue Format (CRITICAL - MUST FOLLOW EXACTLY):**
        Each issue inside the \`<details>\` block MUST use this exact format for automated parsing:

        <example-snippet>
        #### Issue 1: Brief description of the issue
        **ID:** file-slug-semantic-slug-hash
        **File:** path/to/file.js:123
        **Severity:** HIGH
        **Category:** security
        **Context:** Detailed explanation of the issue and why it's problematic.
        **Recommendation:** Specific steps to fix the issue.
        </example-snippet>

        **Required fields:**
        - Issue header: MUST start with \\\"#### Issue N:\\\" where N is the issue number (1, 2, 3, etc.)
        - ID: MUST follow format \\\"{file-slug}-{semantic-slug}-{hash}\\\" (see ID Generation Rules below)
        - File reference: MUST use format \\\"**File:** path/to/file.ext:lineNumber\\\" (e.g., \\\"**File:** src/index.ts:42\\\")
        - Severity: MUST be one of HIGH, MEDIUM, or LOW (use \\\"**Severity:** HIGH\\\")

        **Optional fields:**
        - Category: e.g., \\\"**Category:** security\\\", \\\"**Category:** performance\\\", \\\"**Category:** code_quality\\\"
        - Context: Use \\\"**Context:**\\\" to explain WHY the issue is problematic (STRONGLY RECOMMENDED - this appears in inline comments)
        - Recommendation: Use \\\"**Recommendation:**\\\" or \\\"**Fix:**\\\" followed by suggested solution (see Recommendation Guidelines below)
        - Exploit Scenario: Use \\\"**Exploit Scenario:**\\\" for security issues

        **Recommendation Guidelines:**
        When providing recommendations, ALWAYS include a concrete code snippet when there is a clear, specific fix:
        - **DO** provide minimal, focused code snippets showing the exact fix
        - **DO** show before/after comparisons when helpful
        - **DO** include only the relevant lines that need to change
        - **DON'T** provide entire example implementations or reference code
        - **DON'T** include boilerplate or unrelated code
        - **DON'T** provide general advice without code when a specific fix exists

        **Code Snippet Format:**
        Use markdown code blocks with language identifier. Keep snippets minimal (1-10 lines typically).

        **Examples of Good Recommendations:**
        <example-snippet>
        - \\\"Use parameterized queries:\\\`\\\`\\\`typescript
          const result = await db.query('SELECT * FROM users WHERE id = $1', [userId]);
          \\\`\\\`\\\`\\\"
        - \\\"Add input validation:\\\`\\\`\\\`javascript
          if (!email || !email.match(/^[^@]+@[^@]+$/)) {
            throw new Error('Invalid email');
          }
          \\\`\\\`\\\`\\\"
        - \\\"Increase max-age to 1 year:\\\`\\\`\\\`javascript
          res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');
          \\\`\\\`\\\`\\\"
        </example-snippet>

        **ID Generation Rules:**
        Generate a stable, deterministic ID for each issue using this format: {file-slug}-{semantic-slug}-{hash}

        1. **file-slug**: Extract the filename (without extension) from the File path, take first 12 chars, lowercase, remove special chars
           - Example: \\\"src/auth/login.ts\\\" â†’ \\\"login\\\" or \\\"src/payment-api.js\\\" â†’ \\\"payment-api\\\"

        2. **semantic-slug**: Extract 2-4 key terms from the issue description, lowercase, hyphen-separated
           - Example: \\\"SQL injection vulnerability\\\" â†’ \\\"sql-injection\\\"
           - Example: \\\"Missing input validation\\\" â†’ \\\"missing-validation\\\"
           - Example: \\\"Weak cryptographic algorithm\\\" â†’ \\\"weak-crypto\\\"

        3. **hash**: Take the first 4 characters of SHA256(file_path + description)
           - This ensures uniqueness even for similar issues
           - Example: SHA256(\\\"src/auth/login.ts:SQL injection\\\").substring(0,4) â†’ \\\"f3a2\\\"

        **ID Examples:**
        - File: \\\"src/auth/login.ts\\\", Issue: \\\"SQL injection in user query\\\" â†’ **ID:** login-sql-injection-f3a2
        - File: \\\"api/payment.js\\\", Issue: \\\"Missing input validation\\\" â†’ **ID:** payment-missing-validation-8b91
        - File: \\\"lib/crypto.ts\\\", Issue: \\\"Weak algorithm in encryption\\\" â†’ **ID:** crypto-weak-algorithm-c4d5

        **Format Rules:**
        - NEVER use '#number' format (e.g., #1, #2, #3) as GitHub interprets these as issue references
        - Always use \\\"Issue N:\\\" not \\\"Issue #N:\\\"
        - File paths must include line numbers in format \\\"file.ext:123\\\"
        - Severity must be uppercase: HIGH, MEDIUM, or LOW
        - Each issue must be separated by a blank line

        <example-snippet>
        <details>
        <summary>Found 1 issue(s)</summary>

        #### Issue 1: SQL injection vulnerability in user query
        **ID:** users-sql-injection-f3a2
        **File:** src/database/users.ts:45
        **Severity:** HIGH
        **Category:** security
        **Context:** The query concatenates user input directly without parameterization, allowing SQL injection attacks.
        **Recommendation:** Use parameterized queries to prevent SQL injection:
        \\\`\\\`\\\`typescript
        // Replace this:
        const result = await db.query(\\\`SELECT * FROM users WHERE id = '\${userId}'\\\`);

        // With this:
        const result = await db.query('SELECT * FROM users WHERE id = $1', [userId]);
        \\\`\\\`\\\`

        </details>

        ---

        ### Automated Checks
        âœ… No external domain URLs detected
        </example-snippet>

        **Feedback Style:**
        - Provide constructive feedback with specific suggestions for improvement
        - Consider the impact on the overall system architecture and user experience
        - Focus exclusively on problems and their solutions - no commentary on well-functioning code"
        fi

        # Set environment variable for the next step
        echo "REVIEW_PROMPT<<EOF" >> $GITHUB_ENV
        echo "$PROMPT" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Check timeout_minutes deprecation
      shell: bash
      run: |
        if [[ -n "${{ inputs.timeout_minutes }}" ]]; then
          echo "::warning::The 'timeout_minutes' input is deprecated and has no effect in claude-code-action@v1. Please use job-level 'timeout-minutes' instead. See: https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#jobsjob_idtimeout-minutes"
        fi

    - name: Automatic PR Review
      uses: anthropics/claude-code-action@v1
      with:
        anthropic_api_key: ${{ inputs.anthropic_api_key }}
        prompt: ${{ env.REVIEW_PROMPT }}
        track_progress: true
        claude_args: --model ${{ inputs.model }} --allowedTools "Read,Glob,Grep,Task,WebFetch"
        allowed_bots: devin-ai-integration[bot]

    - name: Extract findings from Claude's comment
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GITHUB_TOKEN: ${{ github.token }}
      run: |
        echo "Extracting findings from Claude's PR comment..."

        SCRIPT_PATH="${{ github.action_path }}/scripts/extract-findings-from-comment.js"

        if [[ ! -f "$SCRIPT_PATH" ]]; then
          echo "::warning::Extract findings script not found at $SCRIPT_PATH"
          echo "[]" > findings.json
          exit 0
        fi

        chmod +x "$SCRIPT_PATH"
        node "$SCRIPT_PATH"

    - name: Ensure GitHub CLI and jq for inline comments
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      run: |
        # Install GitHub CLI if needed
        if ! command -v gh >/dev/null 2>&1; then
          echo "::group::Installing GitHub CLI"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y gh
          elif command -v brew >/dev/null 2>&1; then
            brew install gh
          else
            echo "::warning::Unable to auto-install GitHub CLI on this runner. Please ensure gh is available."
          fi
          echo "::endgroup::"
        else
          echo "GitHub CLI already available"
        fi

        # Install jq if needed
        if ! command -v jq >/dev/null 2>&1; then
          echo "::group::Installing jq"
          if command -v apt-get >/dev/null 2>&1; then
            sudo apt-get update && sudo apt-get install -y jq
          elif command -v brew >/dev/null 2>&1; then
            brew install jq
          else
            echo "::warning::Unable to auto-install jq on this runner. Please ensure jq is available."
          fi
          echo "::endgroup::"
        else
          echo "jq already available"
        fi

    - name: Post inline findings comments
      if: inputs.comment_pr_findings == 'true'
      shell: bash
      env:
        GH_TOKEN: ${{ github.token }}
        GITHUB_TOKEN: ${{ github.token }}
        SILENCE_AUTO_REVIEW_COMMENTS: ${{ env.SILENCE_AUTO_REVIEW_COMMENTS }}
      run: |
        if [[ ! -f findings.json ]]; then
          echo "findings.json not present, skipping inline comment step."
          exit 0
        fi

        # Check if findings.json has any findings
        FINDINGS_COUNT=$(jq 'length' findings.json 2>/dev/null || echo "0")
        if [[ "$FINDINGS_COUNT" -eq 0 ]]; then
          echo "No findings to comment on (findings.json is empty)."
          exit 0
        fi

        echo "Found $FINDINGS_COUNT findings to comment on."

        SCRIPT_PATH="${{ github.action_path }}/scripts/comment-pr-findings.js"

        if [[ ! -f "$SCRIPT_PATH" ]]; then
          echo "::warning::Inline comment script not found at $SCRIPT_PATH"
          exit 0
        fi

        chmod +x "$SCRIPT_PATH"
        node "$SCRIPT_PATH"
